<!DOCTYPE html>
<html lang="en">
<head>
        <title>Bulk delete databases in MSSQL using Python</title>
        <meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="shortcut icon" href="/theme/images/favicon.ico"/>
        <link rel="stylesheet" href="/theme/css/main.css" type="text/css" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="/css/ie.css"/>
                <script src="/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="/css/ie6.css"/><![endif]-->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js" type="text/javascript"></script>


</head>

<body id="index" class="home">
	
  <!-- <header id="banner" class="body"> -->
  <!--               <h1><a href="/"><img src="http://www.launchyard.com/images/logo.png" /></a></h1> -->
  <!--       </header> --> 

  <div class="LaunchyardDetail">
    <!-- <p> -->
    <!-- <img src="/theme/images/blue-pin.png" width="100" height="100" alt="Graph icon"> -->
    <!-- </p> -->
    <p><a id="sitesubtitle" href="/"></a></p>
    <p><a id="aboutlink" href="/pages/about.html">about</a></p>

    <!-- <ul> -->
    <!--   <li><a href="/pages/about.html">about</a></li> -->
      <!-- <li><a href="/pages/about.html">articles</a></li> -->
<!--  -->
<!--         <br/> -->
<!--         <br/> -->
<!--      -->        
<!--       <li><a href="">Bulk delete databases in MSSQL using Python</a></li> -->
<!--      -->        
<!--       <li><a href="">That time I did IT work during a surgery</a></li> -->
<!--      -->
<!--  -->
    <!-- </ul> -->

    <!-- This belongs in the about page -->
      <!--  -->
      <!-- <a href="https://github.com/jymmyboi">github</a> -->
      <!-- <br/> -->
      <!--  -->
      <!-- <a href="https://twitter.com/jymmyboi">twitter</a> -->
      <!-- <br/> -->
      <!--  -->

<!-- <ul>
	<li><a href="/category/misc.html">misc</a></li>
</ul>
 -->
  </div>

<section id="content" >
    <div class="body">
      <article>
        <header>
          <h1 class="entry-title">
            <a href="/bulk-delete-databases-in-mssql-using-python.html" rel="bookmark"
               title="Permalink to Bulk delete databases in MSSQL using Python">Bulk delete databases in MSSQL using Python</a></h1>

        </header>

        <div class="entry-content">
<div class="post-info">
	<ul>
        <li class="vcard author">
                 by&nbsp;<a class="url fn" href="/author/jymmyboi.html">jymmyboi</a>
        </li>
        <li class="published" title="2024-03-26T00:00:00+10:30">
          on&nbsp;Tue 26 March 2024
        </li>

	</ul>

</div><!-- /.post-info -->          <p><strong>THIS IS SUPER SIMPLE BUT I HAVE FOUND A LOT OF VALUE OUT OF THIS SCRIPT</strong></p>
<p>In my current position in software support, I need to restore multiple databases a week for different versions of our software. With that comes a lot of bloating of my local SQL instance.</p>
<p>For a while now I have been talking about culling my restored databases but I didn't want to have to go through the GUI and my SQL knowledge is very much limited to basic queries so I feel a lot more comfortable dealing with Python and scripting that way rather than doing this natively through SSMS.</p>
<p>I was at least tipped off about the following query:</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">sysdatabases</span>
</code></pre></div>

<p>Which returns a list of all databases. So the next step was excluding databases as MSSQL has 4 system databases and there were a couple databases I didn't want deleted.</p>
<p>I opted to exclude the system databases from within the script and then have the user update a text file that would contain databases to exclude from the delete list.</p>
<p>From here the flowchart was essentially boiled down to </p>
<p><strong>Grab databases to exclude &gt; Grab all databases minus the ones to exclude &gt; Loop through dropping databases from the delete list.</strong></p>
<p>The resulting script looks as follows</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pymssql</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">excluded_dbs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">db_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">system_dbs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;master&#39;</span><span class="p">,</span><span class="s1">&#39;model&#39;</span><span class="p">,</span><span class="s1">&#39;msdb&#39;</span><span class="p">,</span><span class="s1">&#39;tempdb&#39;</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">get_exclusions</span><span class="p">():</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;excluded_dbs.txt&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">excluded_dbs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">get_databases</span><span class="p">(</span><span class="n">cursor</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name FROM sys.sysdatabases&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excluded_dbs</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">system_dbs</span><span class="p">:</span>
                <span class="n">db_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;[&#39;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;]&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;An exception occurred: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">delete_databases</span><span class="p">(</span><span class="n">cursor</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">db_list</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP DATABASE &quot;</span> <span class="o">+</span> <span class="n">item</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DROPPED DATABASE &quot;</span> <span class="o">+</span> <span class="n">item</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;An exception occurred: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">server</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Server Name: &quot;</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Username: &quot;</span><span class="p">)</span>
    <span class="n">password</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Password: &quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">pymssql</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="s1">&#39;master&#39;</span><span class="p">)</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">(</span><span class="n">as_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;An exception occurred: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">autocommit</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">get_exclusions</span><span class="p">()</span>
    <span class="n">get_databases</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
    <span class="n">delete_databases</span><span class="p">(</span><span class="n">cursor</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</code></pre></div>

<p>The source code and such can be found at my <a href="https://github.com/jymmyboi/MSSQL-Bulk-Database-Delete">GitHub</a></p>
        </div><!-- /.entry-content -->

      </article>
    </div>
</section>
        <section id="extras" >
        
        </section><!-- /#extras -->
	
        <footer id="contentinfo" >
                <address id="about" class="vcard ">
                Proudly powered by <a href="http://getpelican.com/" target="_blank">Pelican</a>, which takes
                great advantage of <a href="http://python.org" target="_blank">Python</a>.
		
                </address><!-- /#about -->
		

                
        </footer><!-- /#contentinfo -->

</body>
</html>